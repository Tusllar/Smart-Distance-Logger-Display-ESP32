# Sơ đồ luồng hoạt động hệ thống Smart_Embed

## 🏗️ Kiến trúc tổng quan

```
┌─────────────────────────────────────────────────────────────────┐
│                    ESP32-C3 Smart Embed System                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Hardware      │  │   Software      │  │   Network       │ │
│  │   Components    │  │   Components    │  │   Interface     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 🔧 Cấu trúc phần cứng

```
┌─────────────────────────────────────────────────────────────────┐
│                        Hardware Layer                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ESP32-C3                                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │   OLED      │  │ Ultrasonic  │  │     LED     │  │  SD Card│ │
│  │ Display     │  │   Sensor    │  │   Warning   │  │  Storage│ │
│  │             │  │   HC-SR04   │  │             │  │         │ │
│  │ GPIO 3,4    │  │ GPIO 6,7    │  │  GPIO 1     │  │   SPI   │ │
│  │ (I2C)       │  │             │  │             │  │         │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 💻 Cấu trúc phần mềm

```
┌─────────────────────────────────────────────────────────────────┐
│                      Software Architecture                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    FreeRTOS Tasks                          │ │
│  │                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │ Sensor Task │  │ Display Task│  │  LED Task   │        │ │
│  │  │ Priority: 3 │  │ Priority: 2 │  │ Priority: 2 │        │ │
│  │  │ 500ms loop  │  │ 200ms loop  │  │ 100ms loop  │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  │                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐                          │ │
│  │  │HTTP Server  │  │ SD Card Task│                          │ │
│  │  │ Priority: 1 │  │ Priority: 2 │                          │ │
│  │  │ 30s monitor │  │ 100ms save  │                          │ │
│  │  └─────────────┘  └─────────────┘                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Component Layer                         │ │
│  │                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │ Ultrasonic  │  │  OLED       │  │ HTTP Server │        │ │
│  │  │   Sensor    │  │  Driver     │  │    App      │        │ │
│  │  │             │  │             │  │             │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  │                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐                          │ │
│  │  │ SD Card     │  │ WiFi        │                          │ │
│  │  │   SPI       │  │ Component   │                          │ │
│  │  └─────────────┘  └─────────────┘                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 Luồng hoạt động chính

```
┌─────────────────────────────────────────────────────────────────┐
│                     Main Application Flow                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. System Initialization                                      │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ app_main()                                              │ │
│     │ ├── Initialize WiFi (Station Mode)                     │ │
│     │ ├── Initialize OLED Display                            │ │
│     │ ├── Initialize Ultrasonic Sensor                       │ │
│     │ ├── Initialize SD Card                                 │ │
│     │ └── Create FreeRTOS Tasks                              │ │
│     └─────────────────────────────────────────────────────────┘ │
│                              │                                 │
│                              ▼                                 │
│  2. Task Execution                                           │ │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ Sensor Task (500ms)                                    │ │
│     │ ├── Read ultrasonic distance                           │ │
│     │ ├── Validate range (2cm - 4m)                         │ │
│     │ ├── Update global variables                            │ │
│     │ └── Send to distance queue                             │ │
│     └─────────────────────────────────────────────────────────┘ │
│                              │                                 │
│                              ▼                                 │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ Display Task (200ms)                                   │ │
│     │ ├── Read global distance                               │ │
│     │ ├── Update OLED display                                │ │
│     │ └── Show status information                            │ │
│     └─────────────────────────────────────────────────────────┘ │
│                              │                                 │
│                              ▼                                 │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ LED Task (100ms)                                       │ │
│     │ ├── Check distance < 10cm threshold                    │ │
│     │ ├── Turn ON LED if below threshold                     │ │
│     │ └── Turn OFF LED if above threshold                    │ │
│     └─────────────────────────────────────────────────────────┘ │
│                              │                                 │
│                              ▼                                 │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ SD Card Task (100ms)                                   │ │
│     │ ├── Read from distance queue                           │ │
│     │ ├── Get timestamp                                      │ │
│     │ └── Save to CSV file                                   │ │
│     └─────────────────────────────────────────────────────────┘ │
│                              │                                 │
│                              ▼                                 │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ HTTP Server Task (30s monitor)                         │ │
│     │ ├── Start HTTP server (after 5s delay)                │ │
│     │ ├── Serve web interface                                │ │
│     │ ├── Handle API requests                                │ │
│     │ └── Monitor system status                              │ │
│     └─────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 🌐 Network Interface Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      Network Communication                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  WiFi Station Mode                                             │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ SSID: "4 chi em"                                           │ │
│  │ Password: "daytro6868"                                     │ │
│  │ IP: 192.168.1.10 (DHCP)                                   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                 │
│                              ▼                                 │
│  HTTP Server (Port 80)                                       │ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Endpoints:                                                 │ │
│  │ ├── GET /hello → Serve web interface                      │ │
│  │ ├── GET /ultrasonic → Get distance data                   │ │
│  │ ├── GET /led?state=on/off → Control LED                   │ │
│  │ ├── GET /led/status → Get LED status                      │ │
│  │ └── GET /sensor/history → Get historical data             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                 │
│                              ▼                                 │
│  Web Interface                                               │ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Features:                                                  │ │
│  │ ├── Real-time distance monitoring                          │ │
│  │ ├── LED control interface                                  │ │
│  │ ├── Historical data chart                                  │ │
│  │ ├── Performance optimization                               │ │
│  │ └── Responsive design                                      │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                        Data Flow                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Ultrasonic Sensor                                             │
│  ┌─────────────┐                                               │
│  │ HC-SR04     │ ──────┐                                       │
│  │ GPIO 6,7    │       │                                       │
│  └─────────────┘       │                                       │
│                        ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              Global Variables                              │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │ g_distance  │  │g_distance_  │  │g_led_status │        │ │
│  │  │ (float)     │  │valid (bool) │  │ (int)       │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                        │                                       │
│                        ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  FreeRTOS Queues                           │ │
│  │  ┌─────────────┐  ┌─────────────┐                         │ │
│  │  │ distance_   │  │ led_queue   │                         │ │
│  │  │ queue       │  │ (4 items)   │                         │ │
│  │  │ (8 items)   │  │             │                         │ │
│  │  └─────────────┘  └─────────────┘                         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                        │                                       │
│                        ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Output Destinations                     │ │
│  │                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │ OLED        │  │ LED Warning │  │ SD Card     │        │ │
│  │  │ Display     │  │ GPIO 1      │  │ CSV File    │        │ │
│  │  │             │  │             │  │             │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  │                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐                         │ │
│  │  │ Web         │  │ HTTP API    │                         │ │
│  │  │ Interface   │  │ Endpoints   │                         │ │
│  │  └─────────────┘  └─────────────┘                         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 🔧 GPIO Pin Mapping

```
┌─────────────────────────────────────────────────────────────────┐
│                        GPIO Configuration                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ESP32-C3 GPIO Assignments                                     │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Function        │ GPIO │ Pin │ Direction │ Description      │ │
│  ├─────────────────┼──────┼─────┼───────────┼──────────────────┤ │
│  │ OLED SDA        │   3  │     │ Output    │ I2C Data         │ │
│  │ OLED SCL        │   4  │     │ Output    │ I2C Clock        │ │
│  │ Ultrasonic TRIG │   6  │     │ Output    │ Trigger Signal  │ │
│  │ Ultrasonic ECHO │   7  │     │ Input     │ Echo Signal      │ │
│  │ LED Warning     │   1  │     │ Output    │ Warning LED      │ │
│  │ SD Card MISO    │  19  │     │ Input     │ SPI Data In      │ │
│  │ SD Card MOSI    │  23  │     │ Output    │ SPI Data Out     │ │
│  │ SD Card CLK     │  18  │     │ Output    │ SPI Clock        │ │
│  │ SD Card CS      │   5  │     │ Output    │ SPI Chip Select  │ │
│  └─────────────────┴──────┴─────┴───────────┴──────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## ⚡ Performance Specifications

```
┌─────────────────────────────────────────────────────────────────┐
│                     Performance Metrics                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Task Performance                                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Task Name       │ Priority │ Stack │ Period │ Function      │ │
│  ├─────────────────┼──────────┼───────┼────────┼───────────────┤ │
│  │ sensor_task     │    3     │ 4KB   │ 500ms  │ Read sensor   │ │
│  │ led_task        │    2     │ 2KB   │ 100ms  │ Control LED   │ │
│  │ display_task    │    2     │ 4KB   │ 200ms  │ Update OLED   │ │
│  │ sdcard_task     │    2     │ 4KB   │ 100ms  │ Save data     │ │
│  │ http_server_task│    1     │ 8KB   │ 30s    │ Monitor HTTP  │ │
│  │ app_main        │    1     │ 8KB   │ 10s    │ System monitor│ │
│  └─────────────────┴──────────┴───────┴────────┴───────────────┘ │
│                                                                 │
│  System Resources                                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Memory Usage:                                               │ │
│  │ ├── Total Stack: ~22KB                                     │ │
│  │ ├── FreeRTOS Heap: Dynamic                                 │ │
│  │ ├── Component Memory: Optimized                            │ │
│  │ └── Web Interface: Embedded in firmware                    │ │
│  │                                                             │ │
│  │ Network Performance:                                        │ │
│  │ ├── WiFi: Station mode, DHCP                               │ │
│  │ ├── HTTP Server: Port 80, concurrent connections           │ │
│  │ ├── API Response: <100ms                                   │ │
│  │ └── Web Interface: Real-time updates                       │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
